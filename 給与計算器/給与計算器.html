<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <title>給与計算機</title>
    <style>
        :root {
            --primary-color: #007bff;
            --background-color: #f8f9fa;
            --text-color: #333;
            --border-color: #dee2e6;
            --warning-color: #dc3545;
            --card-bg: #ffffff;
            --deduction-bg: #ffebee; /* 薄い赤色 */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="number"], input[type="month"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }
        .input-group { display: flex; gap: 10px; }
        .input-group > div { flex: 1; }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: right; }
        th { background-color: #e9ecef; text-align: center; }
        td:first-child { font-weight: bold; text-align: center; }
        .deduction-col { background-color: var(--deduction-bg); }
        .totals-section, .walls-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .totals-section p, .walls-section p { margin: 5px 0; }
        .totals-section strong { display: inline-block; width: 150px; }
        .warning-red { color: var(--warning-color); font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <header><h1>給与計算機</h1></header>

        <main>
            <div class="card">
                <h2>基本設定</h2>
                <div class="form-group">
                    <label for="calculation-mode">計算方法</label>
                    <select id="calculation-mode">
                        <option value="marugame">丸亀基準で計算する</option>
                        <option value="custom">自分で指定して計算する</option>
                    </select>
                </div>
                <div id="custom-settings" class="hidden">
                    <div class="input-group">
                        <div><label for="custom-hourly-wage">時給 (円)</label><input type="number" id="custom-hourly-wage" placeholder="1200"></div>
                        <div><label for="custom-night-premium">深夜割増 (%)</label><input type="number" id="custom-night-premium" placeholder="25"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>データ入力</h2>
                <div class="form-group"><label for="target-month">対象年月</label><input type="month" id="target-month"></div>
                <div class="form-group"><label for="work-days">出勤日数</label><input type="number" id="work-days" placeholder="例: 15"></div>
                
                <div class="form-group"><label for="hour-input-mode">勤務時間の入力方法</label><select id="hour-input-mode"><option value="decimal">時間単位</option><option value="hm">時間と分</option></select></div>
                
                <div id="total-hours-decimal-input">
                    <label for="total-decimal-hours">総労働時間</label><input type="number" id="total-decimal-hours" placeholder="例: 165.5">
                </div>
                <div id="total-hours-hm-input" class="input-group hidden">
                    <div><label for="total-h-hours">時間</label><input type="number" id="total-h-hours"></div>
                    <div><label for="total-m-minutes">分</label><input type="number" id="total-m-minutes"></div>
                </div>

                <div id="night-hours-decimal-input" class="form-group">
                    <label for="night-decimal-hours">深夜労働時間</label><input type="number" id="night-decimal-hours" placeholder="例: 20.25">
                </div>
                <div id="night-hours-hm-input" class="input-group hidden form-group">
                    <div><label for="night-h-hours">時間</label><input type="number" id="night-h-hours"></div>
                    <div><label for="night-m-minutes">分</label><input type="number" id="night-m-minutes"></div>
                </div>

                <div id="makanai-section">
                    <div class="form-group"><label for="makanai-input-mode">賄いの入力方法</label><select id="makanai-input-mode"><option value="count">回数で入力</option><option value="amount">金額で入力</option></select></div>
                    <div class="form-group" id="makanai-count-group"><label for="makanai-count">賄いを食べた回数</label><input type="number" id="makanai-count"></div>
                    <div class="form-group hidden" id="makanai-amount-group"><label for="makanai-amount">賄い金額</label><input type="number" id="makanai-amount"></div>
                </div>

                <button id="add-update-button">登録・更新</button>
            </div>

            <div class="card">
                <h2>集計表</h2>
                <div class="input-group">
                    <div><label for="view-year">年度選択</label><select id="view-year"></select></div>
                    <div><label for="view-month">月選択</label><select id="view-month"><option value="all">年間表示</option><option value="1">1月</option><option value="2">2月</option><option value="3">3月</option><option value="4">4月</option><option value="5">5月</option><option value="6">6月</option><option value="7">7月</option><option value="8">8月</option><option value="9">9月</option><option value="10">10月</option><option value="11">11月</option><option value="12">12月</option></select></div>
                </div>
                <table>
                    <thead><tr><th>月</th><th>出勤日数</th><th>総労働時間</th><th>総支給額</th><th class="deduction-col">賄い/回数</th><th class="deduction-col">労働組合費</th><th>差引支給額</th></tr></thead>
                    <tbody id="summary-table-body"></tbody>
                </table>
                <div class="totals-section">
                    <h3>合計</h3>
                    <p><strong>合計出勤日数:</strong> <span id="total-days">0</span> 日</p>
                    <p><strong>合計勤務時間:</strong> <span id="total-hours">0時間0分</span></p>
                    <p><strong>総支給額合計:</strong> <span id="total-gross">0</span> 円</p>
                    <p><strong>賄い合計:</strong> <span id="total-makanai">0</span> 円</p>
                    <p><strong>労働組合費合計:</strong> <span id="total-union">0</span> 円</p>
                    <p><strong>差引支給額合計:</strong> <span id="total-net">0</span> 円</p>
                    <hr>
                    <p><strong>今年の予想収入目安(差引支給額):</strong> <span id="projected-net">0</span> 円</p>
                </div>
            </div>

            <div class="card">
                <h2>税金加算チェック</h2>
                <div id="walls-section" class="walls-section"></div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('Service Worker Registered'))
            .catch(error => console.log('Service Worker registration failed:', error));
    }
    // DOM要素の取得
    const elements = {
        calculationMode: document.getElementById('calculation-mode'),
        customSettings: document.getElementById('custom-settings'),
        customHourlyWage: document.getElementById('custom-hourly-wage'),
        customNightPremium: document.getElementById('custom-night-premium'),
        targetMonthInput: document.getElementById('target-month'),
        workDaysInput: document.getElementById('work-days'),
        hourInputMode: document.getElementById('hour-input-mode'),
        totalHoursDecimalInput: document.getElementById('total-hours-decimal-input'),
        totalDecimalHours: document.getElementById('total-decimal-hours'),
        totalHoursHmInput: document.getElementById('total-hours-hm-input'),
        totalHHours: document.getElementById('total-h-hours'),
        totalMMinutes: document.getElementById('total-m-minutes'),
        nightHoursDecimalInput: document.getElementById('night-hours-decimal-input'),
        nightDecimalHours: document.getElementById('night-decimal-hours'),
        nightHoursHmInput: document.getElementById('night-hours-hm-input'),
        nightHHours: document.getElementById('night-h-hours'),
        nightMMinutes: document.getElementById('night-m-minutes'),
        makanaiSection: document.getElementById('makanai-section'),
        makanaiInputMode: document.getElementById('makanai-input-mode'),
        makanaiCountGroup: document.getElementById('makanai-count-group'),
        makanaiAmountGroup: document.getElementById('makanai-amount-group'),
        makanaiCount: document.getElementById('makanai-count'),
        makanaiAmount: document.getElementById('makanai-amount'),
        addUpdateButton: document.getElementById('add-update-button'),
        viewYear: document.getElementById('view-year'),
        viewMonth: document.getElementById('view-month'),
        summaryTableBody: document.getElementById('summary-table-body'),
        totalDays: document.getElementById('total-days'),
        totalHours: document.getElementById('total-hours'),
        totalGross: document.getElementById('total-gross'),
        totalMakanai: document.getElementById('total-makanai'),
        totalUnion: document.getElementById('total-union'),
        totalNet: document.getElementById('total-net'),
        projectedNet: document.getElementById('projected-net'),
        wallsSection: document.getElementById('walls-section'),
    };

    // アプリケーションの状態管理
    let state = {
        settings: { mode: 'marugame', hourlyWage: 1200, nightPremium: 25 },
        monthlyData: {}
    };
    
    const MARUGAME_DEFAULTS = { hourlyWage: 1200, nightPremium: 0.25, makanaiCostPerMeal: 120 };
    const WALLS = [
        { limit: 1000000, name: "住民税" }, { limit: 1030000, name: "所得税 / 扶養控除" }, { limit: 1060000, name: "社会保険①" },
        { limit: 1300000, name: "社会保険②" }, { limit: 1500000, name: "配偶者特別控除" }, { limit: 2010000, name: "控除終了" }
    ];

    function saveData() { localStorage.setItem('salaryCalculatorState', JSON.stringify(state)); }
    function loadData() {
        const savedState = localStorage.getItem('salaryCalculatorState');
        if (savedState) { state = JSON.parse(savedState); }
    }

    function updateSettingsUI() {
        elements.calculationMode.value = state.settings.mode;
        const isMarugame = state.settings.mode === 'marugame';
        elements.customSettings.classList.toggle('hidden', isMarugame);
        elements.makanaiSection.classList.toggle('hidden', !isMarugame);
        if (!isMarugame) {
            elements.customHourlyWage.value = state.settings.hourlyWage;
            elements.customNightPremium.value = state.settings.nightPremium;
        }
    }

    function updateHourInputUI() {
        const isDecimal = elements.hourInputMode.value === 'decimal';
        elements.totalHoursDecimalInput.classList.toggle('hidden', !isDecimal);
        elements.totalHoursHmInput.classList.toggle('hidden', isDecimal);
        elements.nightHoursDecimalInput.classList.toggle('hidden', !isDecimal);
        elements.nightHoursHmInput.classList.toggle('hidden', isDecimal);
    }
    
    function updateMakanaiInputUI() {
        const isCount = elements.makanaiInputMode.value === 'count';
        elements.makanaiCountGroup.classList.toggle('hidden', !isCount);
        elements.makanaiAmountGroup.classList.toggle('hidden', isCount);
    }

    function updateView() {
        updateSettingsUI();
        updateHourInputUI();
        updateMakanaiInputUI();
        populateYearFilter();
        renderTable();
    }
    
    function populateYearFilter() {
        const years = new Set(Object.keys(state.monthlyData).map(key => key.substring(0, 4)));
        years.add(new Date().getFullYear().toString());
        const sortedYears = Array.from(years).sort((a, b) => b - a);
        const currentYear = elements.viewYear.value;
        elements.viewYear.innerHTML = '';
        sortedYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = `${year}年度`;
            elements.viewYear.add(option);
        });
        if (sortedYears.includes(currentYear)) {
            elements.viewYear.value = currentYear;
        }
    }

    function calculateUnionFee(gross, isFirstMonth) {
        if (isFirstMonth) return 0;
        const fee = Math.min(gross * 0.01 + 400, 1000);
        return Math.floor(fee / 100) * 100; // 100円未満切り捨て
    }
    
    function formatHours(decimalHours) {
        if (isNaN(decimalHours) || decimalHours === 0) return "0時間0分";
        const hours = Math.floor(decimalHours);
        const minutes = Math.round((decimalHours - hours) * 60);
        return `${hours}時間${minutes}分`;
    }
    
    function formatCurrency(amount) { return Math.round(amount).toLocaleString(); }

    function renderTable() {
        elements.summaryTableBody.innerHTML = '';
        const selectedYear = elements.viewYear.value;
        const selectedMonth = elements.viewMonth.value;
        if (!selectedYear) return;

        let totals = { days: 0, hours: 0, gross: 0, makanai: 0, union: 0, net: 0, makanaiCount: 0 };
        let processedMonths = 0;
        let confirmedNetPaySum = 0;
        
        const dataKeys = Object.keys(state.monthlyData).filter(key => key.startsWith(selectedYear)).sort();
        const firstMonthKey = dataKeys.length > 0 ? dataKeys[0] : null;

        for (let i = 1; i <= 12; i++) {
            const monthKey = `${selectedYear}-${String(i).padStart(2, '0')}`;
            if (selectedMonth !== 'all' && i != selectedMonth) continue;
            
            const data = state.monthlyData[monthKey];
            const row = document.createElement('tr');

            if (data) {
                const hourlyWage = data.settings.mode === 'marugame' ? MARUGAME_DEFAULTS.hourlyWage : data.settings.hourlyWage;
                const nightPremiumRate = data.settings.mode === 'marugame' ? MARUGAME_DEFAULTS.nightPremium : (data.settings.nightPremium / 100);
                
                const basePay = data.totalHours * hourlyWage;
                const nightPay = data.nightHours * hourlyWage * nightPremiumRate;
                const gross = basePay + nightPay;

                const makanaiCost = data.settings.mode === 'marugame' ? data.makanaiCost : 0;
                const unionFee = data.settings.mode === 'marugame' ? calculateUnionFee(gross, monthKey === firstMonthKey) : 0;
                const net = gross - makanaiCost - unionFee;
                
                row.innerHTML = `
                    <td>${i}月</td>
                    <td>${data.days}日</td>
                    <td>${formatHours(data.totalHours)}</td>
                    <td>${formatCurrency(gross)}円</td>
                    <td class="deduction-col">${formatCurrency(makanaiCost)}円 / ${data.makanaiCount}回</td>
                    <td class="deduction-col">${formatCurrency(unionFee)}円</td>
                    <td>${formatCurrency(net)}円</td>
                `;
                
                totals.days += data.days;
                totals.hours += data.totalHours;
                totals.gross += gross;
                totals.makanai += makanaiCost;
                totals.union += unionFee;
                totals.net += net;
                processedMonths++;
                confirmedNetPaySum += net;
            } else {
                 row.innerHTML = `<td>${i}月</td><td>-</td><td>-</td><td>-</td><td class="deduction-col">-</td><td class="deduction-col">-</td><td>-</td>`;
            }
            elements.summaryTableBody.appendChild(row);
        }

        elements.totalDays.textContent = totals.days;
        elements.totalHours.textContent = formatHours(totals.hours);
        elements.totalGross.textContent = formatCurrency(totals.gross);
        elements.totalMakanai.textContent = formatCurrency(totals.makanai);
        elements.totalUnion.textContent = formatCurrency(totals.union);
        elements.totalNet.textContent = formatCurrency(totals.net);

        let projectedNet = totals.net;
        if (processedMonths > 0 && processedMonths < 12) {
            const avgMonthlyNet = confirmedNetPaySum / processedMonths;
            projectedNet = confirmedNetPaySum + (avgMonthlyNet * (12 - processedMonths));
        }
        elements.projectedNet.textContent = formatCurrency(projectedNet);
        
        renderWalls(totals.gross);
    }
    
    function renderWalls(currentGross) {
        elements.wallsSection.innerHTML = '';
        WALLS.forEach(wall => {
            const p = document.createElement('p');
            const remaining = wall.limit - currentGross;
            p.innerHTML = (remaining > 0) 
                ? `✅ ${wall.name}: 超過まであと <strong>${formatCurrency(remaining)}</strong> 円`
                : `❎ ${wall.name}: <strong>${formatCurrency(Math.abs(remaining))}</strong> 円超過`;
            if (remaining <= 100000) { p.classList.add('warning-red'); }
            elements.wallsSection.appendChild(p);
        });
    }

    function getHoursFromInput(type) {
        const isDecimal = elements.hourInputMode.value === 'decimal';
        if (type === 'total') {
            if (isDecimal) return parseFloat(elements.totalDecimalHours.value) || 0;
            const h = parseFloat(elements.totalHHours.value) || 0;
            const m = parseFloat(elements.totalMMinutes.value) || 0;
            return h + m / 60;
        } else { // night
            if (isDecimal) return parseFloat(elements.nightDecimalHours.value) || 0;
            const h = parseFloat(elements.nightHHours.value) || 0;
            const m = parseFloat(elements.nightMMinutes.value) || 0;
            return h + m / 60;
        }
    }
    
    function addOrUpdateData() {
        const targetMonth = elements.targetMonthInput.value;
        if (!targetMonth) { alert('対象年月を選択してください。'); return; }

        let makanaiCost = 0, makanaiCount = 0;
        if (state.settings.mode === 'marugame') {
            if (elements.makanaiInputMode.value === 'count') {
                makanaiCount = parseInt(elements.makanaiCount.value) || 0;
                makanaiCost = makanaiCount * MARUGAME_DEFAULTS.makanaiCostPerMeal;
            } else {
                makanaiCost = parseInt(elements.makanaiAmount.value) || 0;
                makanaiCount = Math.round(makanaiCost / MARUGAME_DEFAULTS.makanaiCostPerMeal);
            }
        }

        state.monthlyData[targetMonth] = {
            days: parseInt(elements.workDaysInput.value) || 0,
            totalHours: getHoursFromInput('total'),
            nightHours: getHoursFromInput('night'),
            makanaiCost: makanaiCost,
            makanaiCount: makanaiCount,
            settings: { ...state.settings }
        };
        
        saveData();
        alert(`${targetMonth} のデータを登録・更新しました。`);
        updateView();
    }

    function loadDataIntoForm() {
        const targetMonth = elements.targetMonthInput.value;
        const data = state.monthlyData[targetMonth];
        const fieldsToReset = [
            elements.workDaysInput, elements.totalDecimalHours, elements.totalHHours, elements.totalMMinutes,
            elements.nightDecimalHours, elements.nightHHours, elements.nightMMinutes, elements.makanaiCount, elements.makanaiAmount
        ];
        if (data) {
            elements.workDaysInput.value = data.days;
            // Total hours
            elements.totalDecimalHours.value = data.totalHours.toFixed(2);
            elements.totalHHours.value = Math.floor(data.totalHours);
            elements.totalMMinutes.value = Math.round((data.totalHours - Math.floor(data.totalHours)) * 60);
            // Night hours
            elements.nightDecimalHours.value = data.nightHours.toFixed(2);
            elements.nightHHours.value = Math.floor(data.nightHours);
            elements.nightMMinutes.value = Math.round((data.nightHours - Math.floor(data.nightHours)) * 60);
            // Makanai
            elements.makanaiCount.value = data.makanaiCount;
            elements.makanaiAmount.value = data.makanaiCost;
        } else {
            fieldsToReset.forEach(el => el.value = '');
        }
    }

    // --- イベントリスナー ---
    elements.calculationMode.addEventListener('change', (e) => { state.settings.mode = e.target.value; saveData(); updateView(); });
    elements.customHourlyWage.addEventListener('input', (e) => { state.settings.hourlyWage = parseFloat(e.target.value) || 0; saveData(); });
    elements.customNightPremium.addEventListener('input', (e) => { state.settings.nightPremium = parseFloat(e.target.value) || 0; saveData(); });
    elements.hourInputMode.addEventListener('change', updateHourInputUI);
    elements.makanaiInputMode.addEventListener('change', updateMakanaiInputUI);
    elements.addUpdateButton.addEventListener('click', addOrUpdateData);
    elements.viewYear.addEventListener('change', renderTable);
    elements.viewMonth.addEventListener('change', renderTable);
    elements.targetMonthInput.addEventListener('change', loadDataIntoForm);

    // --- 初期化処理 ---
    loadData();
    const now = new Date();
    elements.targetMonthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    updateView();
    loadDataIntoForm();
});
</script>

</body>
</html>